<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gemini programmingéšŠã«ã‚ˆã‚‹WebAssembly (Wasm) ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã€‚Rustã‚³ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œå¯èƒ½å½¢å¼ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚">
    <meta name="keywords" content="Wasm, WebAssembly, Rust, ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©, Vercel, Render, Gemini">
    <meta name="author" content="ã‚«ã‚«ã‚ªãƒãƒ¡">
    <meta property="og:title" content="Gemini Wasm ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©">
    <meta property="og:description" content="Rustã‚³ãƒ¼ãƒ‰ã‚’WebAssemblyã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€Webã§å®Ÿè¡Œã—ã¾ã™ã€‚">
    <meta property="og:image" content="/logo.png">
    <meta property="og:url" content="https://xeroxapp032.vercel.app/wasm2">
    <link rel="icon" href="/logo.png" type="image/png">
    <link href="https://kakaomames.github.io/Minecraft-frask-app/static/style.css">
    <title>Gemini programmingéšŠ Wasm ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #333; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status-area { margin-top: 20px; padding: 15px; border-radius: 4px; background-color: #e9ecef; }
        #output-area { margin-top: 20px; padding: 15px; border: 1px dashed #333; background-color: #fff; min-height: 50px; }
        .logo { display: block; margin: 0 auto 10px; width: 50px; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://kakaomames.github.io/rei/logo.png" alt="Gemini Logo" class="logo">
        <h1>Wasm ã‚³ãƒ³ãƒ‘ã‚¤ãƒ© ğŸ¦€âš™ï¸</h1>
        <p>Rustã‚³ãƒ¼ãƒ‰ã¨ã€å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’å®šç¾©ã™ã‚‹ Cargo.toml ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        
        <label for="cargo-toml">Cargo.toml (ä¾å­˜é–¢ä¿‚ã®å®šç¾©)</label>
        <textarea id="cargo-toml" rows="8"></textarea>

        <label for="rust-code">Rust Code (src/lib.rs ã«ç›¸å½“)</label>
        <textarea id="rust-code"></textarea>
        
        <button id="compile-button">ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é–‹å§‹ & ZIPç”Ÿæˆ</button>

        <div id="status-area">
            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="compile-status">æº–å‚™å®Œäº†</span></h3>
            <p>é€²æ—: <span id="compile-progress">0%</span></p>
            <p id="status-message">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <div id="output-area">
            <h3>çµæœ</h3>
            <p id="execution-message">ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸå¾Œã€ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </div>

    <script>
        // --- è¨­å®šã¨å®šæ•° ---
        const COMPILER_URL = '/api/compile';
        const STATUS_URL = '/api/status/';
        const POLLING_INTERVAL = 5000; // 5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
        
        // --- DOMè¦ç´  ---
        const compileButton = document.getElementById('compile-button');
        const rustCodeArea = document.getElementById('rust-code');
        const cargoTomlArea = document.getElementById('cargo-toml'); // â˜…è¿½åŠ â˜…
        const compileStatus = document.getElementById('compile-status');
        const compileProgress = document.getElementById('compile-progress');
        const statusMessage = document.getElementById('status-message');
        const executionMessage = document.getElementById('execution-message');
        
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let isCompiling = false;

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        compileButton.addEventListener('click', () => {
            if (!isCompiling) {
                startCompilation(rustCodeArea.value, cargoTomlArea.value); // â˜… Cargo.toml ã‚’å¼•æ•°ã«è¿½åŠ  â˜…
            }
        });

        // --- ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ---

        async function startCompilation(rustCode, cargoTomlContent) { // â˜… å¼•æ•°ã«è¿½åŠ  â˜…
            isCompiling = true;
            compileButton.disabled = true;
            updateStatus('ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...', 0, 'åˆæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’Vercelã«é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚');
            executionMessage.textContent = 'çµæœå¾…ã¡...';

            try {
                // 1. Vercelã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¿ã‚¹ã‚¯ã‚’ä¾é ¼
                let response = await fetch(COMPILER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        code: rustCode,
                        cargo_toml: cargoTomlContent // â˜…ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«è¿½åŠ  â˜…
                    })
                });

                if (response.status === 202) {
                    const data = await response.json();
                    const taskId = data.task_id;
                    console.log(`Task submitted. ID: ${taskId}. Starting polling.`);
                    
                    // 2. ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’é–‹å§‹
                    await pollForStatus(taskId);

                } else {
                    const errorData = await response.json().catch(() => ({ message: 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼' }));
                    throw new Error(`ã‚¿ã‚¹ã‚¯é–‹å§‹å¤±æ•— (${response.status}): ${errorData.message}`);
                }

            } catch (error) {
                updateStatus('ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¤±æ•—', 0, `ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
            } finally {
                isCompiling = false;
                compileButton.disabled = false;
            }
        }

        async function pollForStatus(taskId) {
            return new Promise((resolve, reject) => {
                const intervalId = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(STATUS_URL + taskId);
                        const statusData = await statusResponse.json();

                        updateStatus('ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸­', statusData.progress, statusData.message);

                        if (statusData.status === 'completed') {
                            clearInterval(intervalId);
                            updateStatus('å®Œäº†', 100, 'Wasmã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­ã§ã™...');
                            await handleSuccessfulCompilation(statusData); 
                            resolve();

                        } else if (statusData.status === 'error') {
                            clearInterval(intervalId);
                            // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚: ãƒ­ã‚°ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ç§»è¡Œ
                            await handleCompilationError(statusData); 
                            reject(new Error(statusData.message || "Renderã‚µãƒ¼ãƒãƒ¼ã§äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"));

                        } else {
                            // å‡¦ç†ä¸­ (in_progress) ã®ã¾ã¾ç¶™ç¶š
                        }
                    } catch (error) {
                        clearInterval(intervalId);
                        updateStatus('ãƒãƒ¼ãƒªãƒ³ã‚°å¤±æ•—', 0, `ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                        reject(error);
                    }
                }, POLLING_INTERVAL);
            });
        }

        // --- ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (æˆåŠŸæ™‚) ---

        /**
         * æˆåŠŸã—ãŸã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ZIPåŒ–ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
         */
        async function handleSuccessfulCompilation(data) {
            try {
                if (typeof JSZip === 'undefined') {
                     throw new Error("JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                }

                const wasmBinary = base64ToArrayBuffer(data.wasm_base64);
                
                // wasm-bindgenã®JSã‚³ãƒ¼ãƒ‰å†…ã® Wasm ãƒ•ã‚¡ã‚¤ãƒ«åå‚ç…§ã‚’ 'wasm_project_bg.wasm' ã‹ã‚‰ 'wasm.wasm' ã«ç½®æ›
                let jsCode = data.js_code.replace(/wasm_project_bg\.wasm/g, 'wasm.wasm');


                // 1. ZIPã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–
                const zip = new JSZip();
                
                // 2. Wasmãƒ•ã‚¡ã‚¤ãƒ« (wasm.wasm) ã®è¿½åŠ  (ArrayBufferã¨ã—ã¦)
                zip.file("wasm.wasm", wasmBinary, { binary: true });
                
                // 3. JSã‚°ãƒ«ãƒ¼ã‚³ãƒ¼ãƒ‰ (script.js) ã®è¿½åŠ 
                zip.file("script.js", jsCode);
                
                // 4. HTMLãƒ•ã‚¡ã‚¤ãƒ« (index.htm) ã®ä½œæˆã¨è¿½åŠ 
                const indexHtmlContent = createIndexHtml();
                zip.file("index.html", indexHtmlContent);

                // 5. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
                updateStatus('å®Œäº†', 100, 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...', false);
                const zipBlob = await zip.generateAsync({ type: "blob" });

                // 6. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®å®Ÿè¡Œ
                const downloadUrl = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = 'wasm_project.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl); // URLã‚’è§£æ”¾

                updateStatus('å®Œäº†', 100, 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚', false);
                executionMessage.className = 'success';
                executionMessage.textContent = 'ğŸ‰ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ (index.htm, script.js, wasm.wasm) ãŒZIPãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚';

            } catch (e) {
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå¤±æ•—', 100, `ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã¾ãŸã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, true);
                executionMessage.className = 'error';
                executionMessage.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                console.error("File generation error:", e);
            }
        }

        // --- ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¨ãƒ©ãƒ¼æ™‚: ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°å‡ºåŠ›) ---

        /**
         * ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ZIPåŒ–ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹
         * @param {object} data - ã‚¨ãƒ©ãƒ¼å¿œç­”ã®JSONãƒ‡ãƒ¼ã‚¿
         */
        async function handleCompilationError(data) {
            try {
                const errMsg = data.message || "Renderã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚";
                updateStatus('ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¤±æ•—', data.progress || 0, `ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç”Ÿæˆä¸­ã§ã™... ã‚¨ãƒ©ãƒ¼: ${errMsg}`, true);
                executionMessage.textContent = `ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ãªãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚`;

                // 1. JSONãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ä½œæˆ
                const logContent = JSON.stringify({
                    timestamp: new Date().toISOString(),
                    status: data.status,
                    progress: data.progress,
                    error_message: errMsg,
                    raw_response: data 
                }, null, 2); // æ•´å½¢ã•ã‚ŒãŸJSON

                // 2. ZIPã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–
                if (typeof JSZip === 'undefined') {
                     throw new Error("JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                }
                const zip = new JSZip();

                // 3. log.json ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
                zip.file("compilation_log.json", logContent);
                
                // 4. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const zipBlob = await zip.generateAsync({ type: "blob" });

                const downloadUrl = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = 'wasm_error_log.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                updateStatus('ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', 0, 'ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’å«ã‚€ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ä¸­èº«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
                executionMessage.className = 'error';
                executionMessage.textContent = `âŒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¤±æ•—ã€‚ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° (wasm_error_log.zip) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`;

            } catch (e) {
                // ZIPç”Ÿæˆè‡ªä½“ãŒå¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†
                updateStatus('è‡´å‘½çš„ãªå¤±æ•—', 0, `ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, true);
                console.error("Error during log file generation:", e);
            }
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        /**
         * Wasmã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãª index.htm ã®å†…å®¹ã‚’ç”Ÿæˆ
         */
        function createIndexHtml() {
            // é–‰ã˜ã‚¿ã‚°ã€Œ</s>ã€ã‚’ã€Œ</scr' + 'ipt>ã€ã«åˆ†å‰²ã—ã¦ã€HTMLãƒ‘ãƒ¼ã‚µãƒ¼ã«èª¤èªè­˜ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
            const SCRIPT_END = '</scr' + 'ipt>';

            return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Wasm å®Ÿè¡Œçµæœ</title>
</head>
<body>
    <h1>Wasm å®Ÿè¡Œçµæœ</h1>
    <p>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚Wasmã§å®šç¾©ã•ã‚ŒãŸé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>
    
    <script>
        window.consoleLog = function(s) {
            console.log("From Wasm: " + s);
        };
    ` + SCRIPT_END + `
    
    <script type="module">
        // wasm-bindgenãŒç”Ÿæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import init, { Game2048 } from './script.js';

        async function run() {
            try {
                // Wasmãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æ˜ç¤ºçš„ã«æ¸¡ã™ã“ã¨ã§ã€GitHub Pagesã§ã®ãƒ‘ã‚¹è§£æ±ºå•é¡Œã‚’å›é¿
                const wasm_module = await init('./wasm.wasm'); 
                
                // Wasmã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸé–¢æ•°ã‚’å–å¾—
                const { Game2048, ping } = wasm_module;
                
                console.log("Wasmãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸã€‚");

                // --- 2048ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ä¾‹ ---
                if (typeof Game2048 !== 'undefined') {
                    const game = Game2048.new();
                    console.log("ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”ŸæˆæˆåŠŸï¼ åˆæœŸã‚¹ã‚³ã‚¢:", game.score);
                    game.place_tile(3, 2);
                    game.move_tiles(3);
                    console.log("ç§»å‹•å¾Œã®ã‚¹ã‚³ã‚¢:", game.score);
                } else if (typeof ping === 'function') {
                    console.log("Pingãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ:", ping());
                }

            } catch (e) {
                console.error("Wasmã®ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
                alert("Wasmã®ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            }
        }
        run();
    ` + SCRIPT_END + `
</body>

</html>`;
        }

        function updateStatus(status, progress, message, isError = false) {
            compileStatus.textContent = status;
            compileProgress.textContent = `${progress}%`;
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : '';
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã®çŠ¶æ…‹è¨­å®š
        updateStatus('æº–å‚™å®Œäº†', 0, 'ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
    </script>
    <script>
    // DOMè¦ç´ ã‚’å–å¾—ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚ãªãã¦ã‚‚æ©Ÿèƒ½ã™ã‚‹ãŒã€ç¢ºèªã®ãŸã‚ã«ã‚ã‚‹ã¨ä¾¿åˆ©ï¼‰
    const statusElement = document.getElementById('status');

    /**
     * Service Worker ã®ç™»éŒ²å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
     */
    function registerServiceWorker() {
        // 1. Service Worker APIãŒãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
        if ('serviceWorker' in navigator) {
            
            // 2. ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ç™»éŒ²ã‚’é–‹å§‹ (æ¨å¥¨ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°)
            window.addEventListener('load', () => {
                
                // /sw.js ã®ãƒ‘ã‚¹ã§ Service Worker ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
                // Service Worker ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(/)ã¨ãªã‚Šã¾ã™ã€‚
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        // ç™»éŒ²æˆåŠŸæ™‚ã®å‡¦ç†
                        console.log('Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
                        if (statusElement) {
                            statusElement.textContent = `Service Worker ç™»éŒ²æˆåŠŸ ğŸ‰ (Scope: ${registration.scope})`;
                        }
                    })
                    .catch(error => {
                        // ç™»éŒ²å¤±æ•—æ™‚ã®å‡¦ç†
                        console.error('Service Worker ç™»éŒ²å¤±æ•—:', error);
                        if (statusElement) {
                            statusElement.textContent = `Service Worker ç™»éŒ²å¤±æ•— ğŸ˜¢: ${error.message}`;
                        }
                    });
            });
        } else {
            // Service Worker ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
            console.warn('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Service Worker ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            if (statusElement) {
                statusElement.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Service Worker ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚';
            }
        }
    }

    // ç™»éŒ²é–¢æ•°ã‚’å®Ÿè¡Œ
    registerServiceWorker();
</script>
</body>
</html>
