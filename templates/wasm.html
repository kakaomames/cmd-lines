<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Vercel Proxy for WASM Build Server">
    <meta name="author" content="Gemini programmingéšŠ éšŠå“¡">
    <meta property="og:title" content="WASM Compiler Client (Vercel Proxy)">
    <meta property="og:description" content="Renderã‚µãƒ¼ãƒãƒ¼ã¸ã®éåŒæœŸãƒ“ãƒ«ãƒ‰ä¾é ¼ãƒšãƒ¼ã‚¸ (VercelçµŒç”±)">
    <meta property="og:image" content="https://kakaomames.github.io/rei/logo.png">
    <link rel="icon" type="image/png" href="https://kakaomames.github.io/rei/logo.png">
    <title>WASM Builder Client (Vercel)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        #status { margin-top: 20px; padding: 15px; border: 1px solid #ffc107; background-color: #fff3cd; }
        .result-box { margin-top: 20px; padding: 15px; border: 1px solid #28a745; background-color: #d4edda; }
        .error-box { margin-top: 20px; padding: 15px; border: 1px solid #dc3545; background-color: #f8d7da; }
    </style>
    <link rel="apple-touch-icon" sizes="180x180" href="/logo.png">
<link rel="icon" type="image/png" sizes="32x32" href="/logo.png">
<link rel="icon" type="image/png" sizes="16x16" href="/logo.png">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://kakaomames.github.io/Minecraft-flask-app/static/style.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="/home">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="/h">GITHUBã«ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ä¿å­˜</a></li>
                <li><a href="/cmd">Webã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ„ãƒ¼ãƒ«</a></li>
                <br>
                <li><a href="/run?cmd=">ç›´æ¥ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ãŸã„æ–¹å‘ã‘...</a></li>
                <li><a href="/link">URLæ¤œç´¢âœ¨</a></li>
                <li><a href="/url-dl">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼</a></li>
                <br>
                <li><a href="/ikkatu-url">ğŸ”—ä¸€æ‹¬URLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ğŸ”—</a></li>
                <li><a href="/mqo">ğŸ“mqoã‹ã‚‰objã«å¤‰æ›ğŸ“</a></li>
                <li><a href="/games">ã‚²ãƒ¼ãƒ ğŸ‘¿</a></li>
                <br>
                <li><a href="/scratch">ğŸ’»ã‚¹ã‚¯ãƒ©ãƒƒãƒã®ãƒ‡ãƒ¼ã‚¿å–å¾—ğŸ±</a></li>
                <li><a href="/dl?data_url=">ğŸ”—ã‚¹ã‚¯ãƒ©ãƒƒãƒãƒ‡ãƒ¼ã‚¿(sb3)ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ğŸ”—</a></li>
                <li><a href="https://kakaomames.github.io/turbowarp/">ğŸ§‘â€ğŸ’»ã‚¹ã‚¯ãƒ©ãƒƒãƒğŸ±</a></li>
                <br>
                <li><a href="/wasm">wasmç‰¹å®š</a></li>
                <li><a href="/wasm3">wasmä½œæˆv1</a></li>
                <li><a href="/pokemonquest"><img src="/logo.png" alt="ãƒ­ã‚´" width="16" height="16">ï¾ï¾Ÿï½¹ï¾“ï¾ï½¸ï½´ï½½ï¾„</a></li>
                <br>
                <li><a href="/wasm2">wasmä½œæˆv2</a></li>

            </ul>
        </nav>
    </header>
    <h1>ğŸš€ Vercel Proxy Client (Gemini programmingéšŠ)</h1>
    <p>Vercelã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ Render WASMã‚µãƒ¼ãƒãƒ¼ã¸ã‚¿ã‚¹ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>

    <h2>Rust ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ (`lib.rs`)</h2>
    <textarea id="rustCode" placeholder="ã“ã“ã«Rustã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: #[no_mangle] pub extern 'C' fn add(a: i32, b: i32) -> i32 { a + b })"></textarea>

    <h2>Cargo.toml (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</h2>
    <textarea id="cargoToml" placeholder="[lib] crate-type = ['cdylib'] ãªã©ã®è¨­å®š" style="height: 100px;">[package]
name = "user_code"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]
</textarea>
    
    <button onclick="submitBuild('rust')">Rust ãƒ“ãƒ«ãƒ‰é–‹å§‹ (POST /api/rust)</button>

    <img src="https://kakaomames.github.io/rei/db/loading_ajax-loader.gif"><div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚¿ã‚¹ã‚¯å¾…æ©Ÿä¸­...</div>

    <div id="result" class="result-box" style="display:none;">
        <h3>âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼</h3>
        <p>ã‚¿ã‚¹ã‚¯ID: <span id="resultTaskId"></span></p>
        <h4>JavaScript ã‚³ãƒ¼ãƒ‰:</h4>
        <textarea id="jsCodeOutput" readonly style="height: 150px;"></textarea>
        <h4>WASM Base64 ãƒ‡ãƒ¼ã‚¿:</h4>
        <textarea id="wasmBase64Output" readonly style="height: 150px;"></textarea>
        <button onclick="saveResultToLocal()">çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜</button>
    </div>

    <div id="localData" style="margin-top: 30px;">
        <h3>ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¼ã‚¿</h3>
        <ul id="localList"></ul>
    </div>

    <script>
        // Vercel Proxyã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
        const PROXY_RUST_ENDPOINT = '/api/rust';
        const PROXY_STATUS_ENDPOINT = '/api/status';

        const STATUS_DIV = document.getElementById('status');
        const RESULT_DIV = document.getElementById('result');
        let pollingInterval = null;

        // ãƒã‚±ãƒ¢ãƒ³ã‚¯ã‚¨ã‚¹ãƒˆã®æŒ‡ç¤ºã«åŸºã¥ããƒšãƒ¼ã‚¸é·ç§»é–¢æ•° (å®šç¾©ã®ã¿)
        function navigateTo(page) {
            document.addEventListener('click', function() { 
                window.location.href = page; 
            });
        }
        
        // ----------------------------------------------------
        // 1. ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¹ã‚¯é€ä¿¡ (Vercel ProxyçµŒç”±)
        // ----------------------------------------------------
        async function submitBuild(lang) {
            STATUS_DIV.innerHTML = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: VercelçµŒç”±ã§Renderã¸ã‚¿ã‚¹ã‚¯é€ä¿¡ä¸­...';
            RESULT_DIV.style.display = 'none';

            const code = document.getElementById('rustCode').value;
            const toml = document.getElementById('cargoToml').value;

            if (!code.trim()) {
                STATUS_DIV.innerHTML = '<span class="error-box">ã‚¨ãƒ©ãƒ¼: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>';
                return;
            }

            const payload = {
                rs: code,
                toml: toml
            };

            try {
                const response = await fetch(PROXY_RUST_ENDPOINT, { // Vercel APIã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    const taskId = data.taskid;
                    STATUS_DIV.innerHTML = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚¿ã‚¹ã‚¯ID <b>${taskId}</b> ã‚’VercelãŒå—ç†ã—ã€ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹...`;
                    startPolling(taskId);
                } else {
                    STATUS_DIV.innerHTML = `<span class="error-box">ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¹ã‚¯é€ä¿¡å¤±æ•—ã€‚ ${data.error || data.message}</span>`;
                }

            } catch (error) {
                STATUS_DIV.innerHTML = `<span class="error-box">é€šä¿¡ã‚¨ãƒ©ãƒ¼: Vercelã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ ${error.message}</span>`;
            }
        }

        // ----------------------------------------------------
        // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒªãƒ³ã‚° (Vercel ProxyçµŒç”±)
        // ----------------------------------------------------
        function startPolling(taskId) {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // 3ç§’ã”ã¨ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
            pollingInterval = setInterval(async () => {
                const url = `${PROXY_STATUS_ENDPOINT}?taskid=${taskId}`; // Vercel APIã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        clearInterval(pollingInterval);
                        displayResult(taskId, data);
                    } else if (data.status === 'failed' || data.status === 'error') {
                        clearInterval(pollingInterval);
                        STATUS_DIV.innerHTML = `<div class="error-box">ğŸš¨ ãƒ“ãƒ«ãƒ‰å¤±æ•—: ${data.message}</div>`;
                    } else if (response.status === 202) {
                        // é€²è¡Œä¸­
                        STATUS_DIV.innerHTML = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: é€²è¡Œä¸­ (<b>${data.status}</b>)... ${data.message}`;
                    } else {
                        // ãã®ä»–ä¸æ˜ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        STATUS_DIV.innerHTML = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ä¸æ˜ãªå¿œç­”... ${data.message}`;
                    }

                } catch (error) {
                    clearInterval(pollingInterval);
                    STATUS_DIV.innerHTML = `<div class="error-box">ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: Vercelã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚</div>`;
                }
            }, 3000); // 3ç§’é–“éš”
        }

        // ----------------------------------------------------
        // 3. çµæœè¡¨ç¤ºã¨ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ©Ÿèƒ½ 
        // ----------------------------------------------------
        function displayResult(taskId, data) {
            STATUS_DIV.innerHTML = 'âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼';
            
            document.getElementById('resultTaskId').textContent = taskId;
            document.getElementById('jsCodeOutput').value = data.js_code;
            document.getElementById('wasmBase64Output').value = data.wasm_base64;
            
            RESULT_DIV.style.display = 'block';
        }

        function saveResultToLocal() {
            const taskId = document.getElementById('resultTaskId').textContent;
            const jsCode = document.getElementById('jsCodeOutput').value;
            const wasmBase64 = document.getElementById('wasmBase64Output').value;

            const savedData = {
                taskId: taskId,
                timestamp: new Date().toISOString(),
                js_code: jsCode,
                wasm_base64: wasmBase64
            };

            try {
                // éšŠå“¡ã®æŒ‡ç¤ºã«åŸºã¥ãJSONå½¢å¼ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                const existingData = JSON.parse(localStorage.getItem('wasm_build_results') || '[]');
                existingData.push(savedData);
                localStorage.setItem('wasm_build_results', JSON.stringify(existingData));
                
                alert(`ãƒ“ãƒ«ãƒ‰çµæœ (ã‚¿ã‚¹ã‚¯ID: ${taskId}) ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                loadLocalData();
            } catch (e) {
                alert('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error(e);
            }
        }

        function loadLocalData() {
            const list = document.getElementById('localList');
            list.innerHTML = '';
            
            try {
                const existingData = JSON.parse(localStorage.getItem('wasm_build_results') || '[]');
                
                if (existingData.length === 0) {
                    list.innerHTML = '<li>ä¿å­˜ã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                    return;
                }

                existingData.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `[${index + 1}] ID: <b>${item.taskId}</b> (${new Date(item.timestamp).toLocaleString()}) <br> <small>WASMãƒ‡ãƒ¼ã‚¿ ${item.wasm_base64.length} ãƒã‚¤ãƒˆ</small>`;
                    list.appendChild(li);
                });

            } catch (e) {
                list.innerHTML = '<li>ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</li>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadLocalData);
    </script>
        <script>
    // DOMè¦ç´ ã‚’å–å¾—ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚ãªãã¦ã‚‚æ©Ÿèƒ½ã™ã‚‹ãŒã€ç¢ºèªã®ãŸã‚ã«ã‚ã‚‹ã¨ä¾¿åˆ©ï¼‰
    const statusElement = document.getElementById('status');

    /**
     * Service Worker ã®ç™»éŒ²å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
     */
    function registerServiceWorker() {
        // 1. Service Worker APIãŒãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
        if ('serviceWorker' in navigator) {
            
            // 2. ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ç™»éŒ²ã‚’é–‹å§‹ (æ¨å¥¨ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°)
            window.addEventListener('load', () => {
                
                // /sw.js ã®ãƒ‘ã‚¹ã§ Service Worker ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
                // Service Worker ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(/)ã¨ãªã‚Šã¾ã™ã€‚
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        // ç™»éŒ²æˆåŠŸæ™‚ã®å‡¦ç†
                        console.log('Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
                        if (statusElement) {
                            statusElement.textContent = `Service Worker ç™»éŒ²æˆåŠŸ ğŸ‰ (Scope: ${registration.scope})`;
                        }
                    })
                    .catch(error => {
                        // ç™»éŒ²å¤±æ•—æ™‚ã®å‡¦ç†
                        console.error('Service Worker ç™»éŒ²å¤±æ•—:', error);
                        if (statusElement) {
                            statusElement.textContent = `Service Worker ç™»éŒ²å¤±æ•— ğŸ˜¢: ${error.message}`;
                        }
                    });
            });
        } else {
            // Service Worker ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ
            console.warn('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Service Worker ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
            if (statusElement) {
                statusElement.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Service Worker ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚';
            }
        }
    }

    // ç™»éŒ²é–¢æ•°ã‚’å®Ÿè¡Œ
    registerServiceWorker();
</script>
</body>
</html>
