<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Scratchãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; }
        input[type="text"] { width: 80%; padding: 10px; margin-right: 10px; }
        button { padding: 10px 20px; cursor: pointer; }
        pre { background-color: #f4f4f4; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-break: break-all; }
        .result-section { margin-top: 20px; border-top: 2px solid #ccc; padding-top: 15px; }
        .download-link, .license-link { margin-top: 15px; display: block; }
    </style>
</head>
<body>
    <h1>Scratchãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿è§£æ</h1>
    <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä»˜ãã‚‚å¯ï¼‰ã€‚</p>
    
    <input type="text" id="projectUrl" placeholder="ä¾‹: https://projects.scratch.mit.edu/123456789?token=..." value="https://scratch.mit.edu/projects/846673644">
    <button onclick="getData()">ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
    
    <a href="/license" target="_blank" class="license-link">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆå…è²¬äº‹é …ï¼‰ã‚’ç¢ºèªã™ã‚‹</a>

    <div id="result" class="result-section" style="display:none;">
        <h2>ğŸ“ è§£æçµæœ</h2>
        <pre id="jsonOutput"></pre>
        
        <p>
            âš ï¸ **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—:** ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ‡ã‚Œã‚‹å‰ã«ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
        </p>
        <button id="downloadButton" onclick="downloadFile()" style="padding: 15px; background-color: #4CAF50; color: white; border: none; border-radius: 5px;">
            ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ« (.sb3) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
    </div>

    <script>
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§APIã‚’å‘¼ã³å‡ºã™é–¢æ•°
        function getData() {
            const fullUrl = document.getElementById('projectUrl').value;
            // URLã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŠ½å‡º (æ­£è¦è¡¨ç¾ã§IDéƒ¨åˆ†ã®ã¿ã‚’å–å¾—)
            //ä¾‹:https://scratch.mit.edu/projects/1059423894
            const match = fullUrl.match(/scratch\.mit\.edu\/projects\/(\d+)/);
            if (!match) {
                alert("æœ‰åŠ¹ãªScratchãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const projectId = match[1];
            
            // Flask APIã¸GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            fetch(`/projects/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    // å–å¾—ã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
                    document.getElementById('jsonOutput').textContent = 
                        JSON.stringify(data, null, 2);
                    document.getElementById('result').style.display = 'block';
                    
                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã« data_url ã‚’ä¿æŒã•ã›ã‚‹
                    const downloadButton = document.getElementById('downloadButton');
                    downloadButton.setAttribute('data-url', data.data_url);
                    
                    alert('ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«é€²ã‚“ã§ãã ã•ã„ã€‚');
                })
                .catch(error => {
                    console.error('API Error:', error);
                    document.getElementById('jsonOutput').textContent = 
                        'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    document.getElementById('result').style.display = 'block';
                });
        }
        
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†é–¢æ•°
        function downloadFile() {
            const downloadButton = document.getElementById('downloadButton');
            const dataUrl = downloadButton.getAttribute('data-url');
            
            if (!dataUrl || dataUrl.includes("ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ")) {
                alert("ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ãŸã‚ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ãã®URLã§å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            // data_urlã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ /dl ã«æ¸¡ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã•ã›ã‚‹
            window.location.href = `/dl?data_url=${encodeURIComponent(dataUrl)}`;
        }
    </script>
</body>
</html>
